services:
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - VPN_SERVICE_PROVIDER=mullvad
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}
      - SERVER_COUNTRIES=${SERVER_COUNTRIES:-Canada}
      - DNS_ADDRESS=10.64.0.1
      - FIREWALL_OUTBOUND_SUBNETS=192.168.1.0/24,100.64.0.0/10,192.200.0.0/24,192.73.240.0/20,199.38.176.0/20,209.177.144.0/20,162.248.220.0/22,208.111.32.0/20
    volumes:
      - gluetun-data:/gluetun
      - ./post-rules.txt:/iptables/post-rules.txt:ro
    restart: unless-stopped

  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_EXTRA_ARGS=--advertise-exit-node --accept-dns=false --hostname=${TS_HOSTNAME:-mullvad-exit}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
    volumes:
      - tailscale-state:/var/lib/tailscale
      - ./start-tailscale.sh:/start-tailscale.sh:ro
    entrypoint: ["/bin/sh", "/start-tailscale.sh"]
    restart: unless-stopped

volumes:
  gluetun-data:
  tailscale-state:
