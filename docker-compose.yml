services:
  gluetun:
    image: qmcgaw/gluetun:latest
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - VPN_SERVICE_PROVIDER=mullvad
      - VPN_TYPE=wireguard
      - WIREGUARD_PRIVATE_KEY=${WIREGUARD_PRIVATE_KEY}
      - WIREGUARD_ADDRESSES=${WIREGUARD_ADDRESSES}
      - SERVER_COUNTRIES=${SERVER_COUNTRIES:-Canada}
      - DNS_ADDRESS=10.64.0.1
      - FIREWALL_OUTBOUND_SUBNETS=192.168.1.0/24,100.64.0.0/10,192.200.0.0/24,102.67.165.0/24,102.67.167.0/24,103.6.84.0/24,157.180.28.0/24,162.248.221.0/24,167.235.72.0/24,172.105.166.0/24,172.105.169.0/24,172.105.179.0/24,172.237.28.0/24,172.237.61.0/24,172.237.66.0/24,172.237.72.0/24,172.238.6.0/24,176.58.88.0/24,176.58.90.0/24,176.58.92.0/24,176.58.93.0/24,178.156.134.0/24,178.156.152.0/24,185.34.3.0/24,185.40.234.0/24,192.73.240.0/24,192.73.242.0/24,192.73.243.0/24,192.73.244.0/24,192.73.248.0/24,192.73.252.0/24,199.38.181.0/24,199.38.182.0/24,205.147.105.0/24,208.111.34.0/24,208.111.40.0/24,208.72.155.0/24,208.83.233.0/24,208.83.234.0/24,209.177.145.0/24,209.177.156.0/24,209.177.158.0/24,45.159.97.0/24,45.159.98.0/24,49.12.193.0/24,49.13.204.0/24,5.161.218.0/24,65.109.143.0/24,68.183.90.0/24,95.217.2.0/24
    volumes:
      - gluetun-data:/gluetun
      - ./post-rules.txt:/iptables/post-rules.txt:ro
    restart: unless-stopped

  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale
    network_mode: "service:gluetun"
    depends_on:
      gluetun:
        condition: service_healthy
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_MODULE
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_EXTRA_ARGS=--advertise-exit-node --accept-dns=false --hostname=${TS_HOSTNAME:-mullvad-exit}
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=false
    volumes:
      - tailscale-state:/var/lib/tailscale
      - ./start-tailscale.sh:/start-tailscale.sh:ro
    entrypoint: ["/bin/sh", "/start-tailscale.sh"]
    restart: unless-stopped

volumes:
  gluetun-data:
  tailscale-state:
